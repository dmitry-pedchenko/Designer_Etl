Designer_Etl

Installing packages:

pip install pandas
pip install pymssql
pip install mysql-connector-python
pip install xlrd

------информация о структуре проекта и запуск скрипта

структура проекта:
	файлы с раширением .py это файлы скрипта и для пользователя не инетресны кроме файла MainExcelParser.py 
	папки: 
		config папка в которую нужно класть файлы конфигурации. Именно в этой папке скрипт ищет по имени файл. Файл нужно
		обязательно называть вместе с расширением т.е. имя.xml

		log папка в которую скрипт записывает логи выполнения загрузки. Для каждого запуска создается отдельная папка с логами,
		для удобства поиска имя папки собирается из имяКонфига + _ + датаИВремяЗапуска. В данной папке создается два файла с логами
		info.txt и debug.txt. В инфо идут логи чисто информативного характера для того чтобы было понятно как прошел сеанс и не мешали логи
		с ошибками если таковые имели место. В файл дебаг идут логи информативного характера а также логи с ошибками, изучив которые по коду 
		ошибки из файла error_cod.txt можно понять суть произошедшего. Если же ошибка произошла внепалановая то обратитесь к разработчику :)
		Если папка log будет удалена то ничего страшного при следующем запуске скрипта она автоматически будет создана и в нее будет положена
		папка с новыми логами

		source папка в которую нужно файлы источников. Тестировалось только на расширении .xlsx но возможно и .xls прокатит

	Как видно из описания достаточно писать имена файлов без каких-либо дополнительных путей. Скрипт сам понимает где он находится и может работать
	из любого места в ОС.

Для запуска скрипта необходимо выполнить следующие шаги: 
Открыть консоль и зайти в папку с проектом, проще всего сделать это следующим образом: открываете в проводнике папку с проектом и выделив и удалив строку
вверху где прописан путь до папки написать cmd и нажать enter таким образом откроется консоль сразу в нужной папке
затем в консли нужно прописать следующую команду 
python MainExcelParser.py --test_mode [true/false] --config имя_файла_конфигурации
первые две команды всегда одни и теже а вот третья это имя файла конфигурации для данного сеанса загрузка
далее будет выведена информация о прохождении сеанса загрузки а также будет указан путь до папки с логами для данного сеанса

-----настройка файла конфигурации

В папке сonfig лежит файл CONFIG.xml это файл конфигурации который служит для понимания структуры конфигурации. В нем
лежит структура файла конфигурации в общем виде

Файл конфигуратор представляет собой файл для настроек загрузки из файла excel в базу данных
файл имеет слудующую структуру
каждое значение заключено в теги вида  <имя_ега>значение</имя_ега>
также у некоторых тегов есть свойства вида <имя_ега mode="значение свойства">значение</имя_ега>
значение свойства бывают ли false либо true
если хотите указать чисто то пишите число в тег, если даже строку то пишите просто строку без ковычек
о предназначении свойств будет рассказано далее

конфигратор имеет следующее древовидное значение:

<?xml version="1.0"?>

<main>
    <dbHost>Db-server</dbHost> имя хоста базы
    <dbUser>sa</dbUser>        имя пользователя базы
    <dbPass>123</dbPass>       пароль от пользователя
    <dbBase>CCURSB</dbBase>    имя базы
    <dbPort>1433</dbPort>.     порт

    <importXml>                в этом блоке лежат блоки описания источников для полей базы
        <path></path>          имя файла excel из которого будет идти загрузка
        <sheetNumber>1</sheetNumber>   номер страницы на которой нужно открыть excel, нумерация с 1

        <columns>              
        	{тут лежит список колонок источников для базы}
        </columns>
    </importXml>

    <exportTable>              в этом блоке лежат блоки описания полей базы данных
        <path>[dbo].[имя_таблицы]</path>   имя таблицы в базе
        <columns>
        	{тут лежит список колонок в базе данных}
        </columns>
    </exportTable>
</main>

выше описанные теги всегда присутсвуют в конфиге независимо от конфигурации базы и файла источника данных

тег testRunMode описывает режим загрузки: при значении true будет запущено в тестовом режиме в котором будет проверено
подключение к базе данных а также будут собраны тестовые запросы на вставку данных, которые будут положены в папку log в файл debug.txt

теги dbHost dbUser dbPass dbBase dbPort описывают подключение к базе и работая с одной и той же базой их менять нет смысла

далее перейдем к блоку в теге importXml
Смысл этого блока в том, что он сожержит данные об источнике данных (файле Excel)
тег path содержит в имя файла Excel. Имя файла должно обязательно содержать в себе расширение .xlsx (.xls опционально)
тег sheetNumber сожержит в себе номер страницы на которой необходимо открыть файл с данными

далее идет тег columns которых содержит в себе теги column, их может быть сколь угодно много. 

Опишем содержимое тега column

            <column>
                <colName>имя_колонки_в_файле</colName>
                <colNameDb>имя_поля_в_базе</colNameDb>
                <colType>тип_колонки_в_файле</colType>
                <valueLength mode="false"></valueLength> тег был придуман на ранней версии и теперь он не имеет смысла но указывать его нужно всегда так как указано
                <transformation mode="false"></transformation> тег был придуман на ранней версии и теперь он не имеет смысла но указывать его нужно всегда так как указано
                <cropEnd mode="false\true">значение(число)</cropEnd>
                <addValueEnd mode="false\true">значение(строка)</addValueEnd>
                <takeFromBegin mode="false\true">значение(число)</takeFromBegin>
                <cropBegin mode="false\true">значение(число)</cropBegin>
                <addValueBegin mode="false\true">значение(строка)</addValueBegin>
                <addValueBoth mode="false\true">значение(строка),значение(строка)</addValueBoth>
                <replace mode="false\true"></replace>
            </column>

выше указанный набор тегов должен быть указан всегда даже если какие-то теги не используются
у некоторых тего есть свойство mode="" это свойство нужно для того чтобы указать работает ли данный
тег или нет, если работает то пишется true и ставится занчение в тег или тег выключен то пишется false и оставляется пустым тег

теперь обо всем по порядку

тег colName указывает для какой колонки в базе этот блок
тег colNameDb указывает в какое поле в базе идут данные из этой колонки он должен быть равен одному из тегов name из блока exportTable
тег colType описывает к какому типу будет преобразовано значение из этой колонки. Принимает значение int или str. Например если в ячейке будет значение "100." то если
не преобразовав и указав str получится в выборке значение 100.0 но если указать int получится 100
теги valueLength и transformation являются устаревшими и указываются для для совместимости версий

далее идут теги со свойствами. 

тег cropEnd принимает значением только число и обрезает указанное значение от конца строки, например если вы хотите включить данный тег то указываете
в свойстве значение я true (это относится ко всем тегам со свойствами) например
<cropEnd mode="true">2</cropEnd>
если вам не нужен этот тег то оставляете как есть
<cropEnd mode="false"></cropEnd>
смысл работы данного тега такой: если например у вас попала строка "Привет" и вы включили этот тег и указали 2 то в результате строка превратится в "Приве"

тег addValueEnd добавляет строку после значения из поля, например если вы указали <addValueEnd mode="true"> мир!</addValueEnd> (пробелы сохраняются) и попалась 
строка "Привет" то в результате получится "Привет мир!"

тег takeFromBegin принимает как значение число,он берет начало строки до указанного значения. Например если строка "Привет" а в теге 2 то получится на выходе "Пр"

тег cropBegin принимает как значение число. Этот тег возращает строку начиная с этого числа до конца строки, например "Привет" а в теге 2 то получится на выходе "ивет"

тег addValueBegin принимает на вход строку. Этот тег добавляет в начала строки строку указанную в теге, например к строке "мир!" а в теге указать 
<addValueBegin mode="true">Привет </addValueBegin> то на выхоже получится "Привет мир!"

тег addValueBoth принимает две строки на вход через запятую. Этот тег добавляет первую строчку в начало строки а вторую в конец.
Например <addValueBoth mode="true">Привет, мир!</addValueBoth> к строке ",чудесный" получится на выходе "Привет, чудесный мир!"

тег replace отвечает за замену значения на другое значение. Если тег выключен то тег имеет вид <replace mode="false"></replace>
Но если вы хотите чтобы значения заменялись в этой строке то нужно включить этот тег прописав mode="true"
После включения этого тега вам нужно теперь добавить теги для замены, это делается следующим образом

                <replace mode="true"> 
                    <replaceVal>
                        <value>строка_которую_надо_заменить</value>
                        <toValue>строка_на_которую_надо_заменить</toValue>
                    </replaceVal>
                </replace>
блок replaceVal включает в себя два тега value и toValue. Тег value принимает строку которую нужно заменить а тег toValue включает в себя строку на которую нужно заменить
блоков replaceVal может быть сколь угодно много, например

                <replace mode="true"> 
                    <replaceVal>
                        <value>1</value>
                        <toValue>*</toValue>
                    </replaceVal>
                    <replaceVal>
                        <value>0</value>
                        <toValue> </toValue>
                    </replaceVal>
                    <replaceVal>
                        <value>3</value>
                        <toValue>**</toValue>
                    </replaceVal>
                </replace>

Если включить все теги cropEnd addValueEnd takeFromBegin cropBegin addValueBegin addValueBoth replace то они все обработают полученную строку
Порядок выполнения операций обработки: cropEnd, cropBegin, addValueEnd, takeFromBegin, addValueBegin, addValueBoth, replace


Надо учесть, что блоков column в теге importXml может быть больше чем колонок в файле Excel, это возникает в том случае, если одна и таже колонока
идет в разные поля в базе. Например

            <column>
                <colName>Name</colName>
                <colNameDb>Name</colNameDb>
                <colType>str</colType>
                <valueLength mode="false"></valueLength>
                <transformation mode="false"></transformation>
                <cropEnd mode="false"></cropEnd>
                <addValueEnd mode="false"></addValueEnd>
                <takeFromBegin mode="false"></takeFromBegin>
                <cropBegin mode="false"></cropBegin>
                <addValueBegin mode="false"></addValueBegin>
                <addValueBoth mode="false"></addValueBoth>
                <replace mode="false"></replace>
            </column>

            <column>
                <colName>Name</colName>
                <colNameDb>Name2</colNameDb>
                <colType>str</colType>
                <valueLength mode="false"></valueLength>
                <transformation mode="false"></transformation>
                <cropEnd mode="false"></cropEnd>
                <addValueEnd mode="false"></addValueEnd>
                <takeFromBegin mode="false"></takeFromBegin>
                <cropBegin mode="false"></cropBegin>
                <addValueBegin mode="false"></addValueBegin>
                <addValueBoth mode="false"></addValueBoth>
                <replace mode="false"></replace>
            </column>

В поле colName в обоих случаях прописывается имя этой колонки, но в поле colNameDb надо указать в каждом блоке имя поля в которое пойдет это значение.
Но количество блоков column в теге exportTable должно быть ровно таким сколько полей в базе данных.




Далее идет блок exportTable
Этот блок описывает поля базы данных

тег path включает в себя имя таблицы в базе данных

Далее идут тег блоков columns
Тег columns описывает поля в базе данных. Он содержит теги column
Структура тега column следующая 

            <column>
                <name>имя_поля_в_базе_данных</name>
                <isAutoInc>является_ли_поле_в_базе_автоинкрементом</isAutoInc>
                <isConc>введено_для_составных_полей_из_нескольких_колонок_но_пока_не_поддерживается</isConc>
                <fromExcel>берется_ли_поле_из_файла_или_дефолтное</fromExcel>
                <defaultValue mode="false\true">дефолтное_значение</defaultValue>
                <colType>str\int</colType>
                <ifNull mode="true\false">значение_если_поле_null</ifNull>
            </column>

тег name включает в себя имя поля в базе данных

тег isAutoInc характеризует является ли данное поле автоинкрементом в базе данных, если значение false то значит что это поле не автоинкремент а если true то значит
что это поле автоинкремент
Если поле автоинкремент то оно просто не включается в запрос на вставку

тег isConc пока не поддерживается и он всегда <isAutoInc>false</isAutoInc>

тег fromExcel описывает берется ли данное поле из файла или он заполняется дефолтным значением

тег defaultValue принимает в себя строку, которую нужно вставлять когда поле не берется из файла. Например 

	<fromExcel>false</fromExcel>
	<defaultValue mode="true">null</defaultValue> 

то значит это поле будет заполняться null'ами

тег colType описывает какого типа будут вставляться строчки. Принимает значение int или str.По сути это значит будет ли вставляемое значение оборачиваться в кавычки или нет. Если поле берется не из файла и по дефолту вставляется null то нужно заполнить это поле значением int так как null в ковычках будет приниматься как строка т.е.
	
	<fromExcel>false</fromExcel>
    <defaultValue mode="true">null</defaultValue>
    <colType>int</colType>

тег ifNull нужен для того, чтобы заменять поля получаемые из базы на другие значение,если они становятся налами. Например


	            <fromExcel>true</fromExcel>
                <defaultValue mode="false"></defaultValue>
                <colType>str</colType>
                <ifNull mode="true">null</ifNull>

То это значит, что полученное значение в случае null заменится на null. Тут в запросе нал будет вставляться без ковычек даже если поле строковое.

Дополнение по обновлению

в блоке описания базы добаивились теги
dbtype тип базы для MSSQL ставим mssql
loadMode режим загрузки для вставки пише insert для апдейта update
dict ставится true если загрузка осуществляется при помощи словарной таблицы из базы, если только грузится из эекселя то ставим false
checkMode если указано true то загрузчик превращается в сравниватель таблиц а если false то программа работает в режиме загрузчика


В теге importXml в блоке с колонками импортированными добавился тег 
isPK
этот тег нужен для проверки колонки на уникалоность значений, можно ставить просто false 

также в тег importXml добавился тег linkedColumns этот тег нужен для режима сравения двух файлов 
Он работает только в режиме checkMode true. В режиме загрузки ставим checkMode false а <linkedColumns mode="false">

в этом теге содержатся теги
pathToLinkFile имя сравниваемого экселя. положить надо тудаже где и все эксели
linkedFileSheetNumber номер страницы на которой открыть сравниваемый эксель. нумерация с 1

дальше идет перечисление колонок для сравнения в теге column
linkedColName имя колонки в сравниаемом экселе
colNameInSource имя колонки в источнике
<both> true если надо сравнивать источник со словарем и обратно словарь с источником. false если только источник со словарем 

если не надо сравнивать и checkMode == false то можно просто оставить тег пустым <linkedColumns mode="false"></linkedColumns>



Также добавился в этот блок тег withDict он нужен для описания словарной таблицы из которой будет браться индекс
Он включает в себя тег tables в котором хранится список таблиц заключенные в теги table
В теге table содержатся следующие теги
dictTableName  имя таблицы словарной из которой берем индекс
indxDbColumn   имя колонки с индексом в целевой таблице куда кладем индекс 
indxColumnDic  имя колонки с индексом в словарной таблице откуда берем индекс

Дальше идут теги с колонками тут все также как в источнике, указываем имя колонки в экселе имя колонки в словарной таблице куда была
загружена эта колонка а также операции которые нуджно сделать с колонкой из экселя

В тег exportTable в блок описания столбцов в применике были добавлены следующие теги

fromDb указывает на то берется ли значение из словарной таблицы в базе. true если берется
isUpdateCondition работает в режиме <loadMode>update</loadMode> если <isUpdateCondition>true</isUpdateCondition> то эта колонка податает в условие WHERE в апдейте и по ней будут искаться колонки для апдейта
Если <ifNull mode="false"></ifNull> и одновременно <defaultValue mode="false"></defaultValue> и колонка берется из экселя то эта колонка будет проверяться на налы

isConc теперь работает. Если <isConc>true</isConc> то просто в описании колонок в источнике в блоке importXml указываем имя этой колонки в тех колонках которые хотим соединить и они автоматически сверху вниз в порядке следования в конфиге соединятся






